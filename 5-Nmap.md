# دليل عملي للفحص باستخدام Nmap (مرحلة الـRecon)

هذا المستند يشرح خطوة بخطوة سكربت الفحص، كل جزء منفصل: ماذا يفعل، لماذا
نستخدمه، وما النتائج المتوقعة. مناسب للتدريب العملي مع فريق مبتدئ.

------------------------------------------------------------------------

## 1) إنشاء مجلد النتائج

``` bash
mkdir -p scans
```

-   ينشئ مجلد `scans/` لتخزين كل المخرجات.\
-   الخيار `-p` يعني لو المجلد موجود لا يطلع خطأ.

------------------------------------------------------------------------

## 2) الفحص الأولي (Top Ports)

``` bash
nmap -sS -T3 --top-ports 1000 -Pn -iL live_hosts.txt -oA scans/topports
```

### التفصيل

-   `-sS` :
فحص SYN (نصف مفتوح).\
-   `-T3` :
توقيت متوازن (آمن ضد الـIDS).\
-   `--top-ports 1000` :
يفحص أكثر 1000 بورت شائع.\
-   `-Pn` :
يتجاهل ping (مفيد لو ICMP محجوب).\
-   `-iL live_hosts.txt` : 
يقرأ قائمة الأهداف من ملف.\
-   `-oA scans/topports` : 
يحفظ النتيجة بصيغ `.nmap`, `.xml`, `.gnmap`.

------------------------------------------------------------------------

## 3) استخراج المضيفين اللي عندهم بورتات مفتوحة

``` bash
awk '/^Host:/{h=$2}/open/{print h}' scans/topports.gnmap | sort -u > scans/targets_with_open.txt
```

-   `awk` يلتقط الـIP لكل host مفتوح.\
-   `sort -u` يرتب ويزيل التكرارات.\
-   النتيجة تخزن في `scans/targets_with_open.txt`.

### بديل أبسط (لو awk صعب)

``` bash
grep "open" scans/topports.gnmap | cut -d' ' -f2 | sort -u > scans/targets_with_open.txt
```

------------------------------------------------------------------------

## 4) التأكد من وجود أهداف

``` bash
[ -s scans/targets_with_open.txt ]
```

-   يتحقق إن الملف غير فارغ.\
-   لو فيه أهداف → نكمل، لو لا → نوقف.

------------------------------------------------------------------------

## 5) الفحص المتقدم للويب

``` bash
nmap -p 80,443,8080,8443 -sV --script=http-enum,http-headers,http-title,http-vhosts,ssl-cert -T3 -iL scans/targets_with_open.txt -oA scans/web-deep
```

### ماذا يجمع؟

-   `http-enum` : مسارات شائعة مثل `/admin`.\
-   `http-headers` : رؤوس HTTP.\
-   `http-title` : عناوين الصفحات.\
-   `http-vhosts` : Virtual hosts.\
-   `ssl-cert` : شهادات TLS (CN, SANs, تاريخ الانتهاء).

------------------------------------------------------------------------

## 6) في حال ما فيه نتائج

``` bash
|| echo "No open hosts found in topports."
```

-   يظهر رسالة واضحة بدل ما يظل ساكت.

------------------------------------------------------------------------

## 7) شرح الرموز الأساسية

-   `&&` : نفِّذ التالي إذا نجح السابق.\
-   `||` : نفِّذ التالي إذا فشل السابق.\
-   `|` : مرِّر النتيجة كدخل للأمر الثاني.\
-   `>` : اكتب فوق الملف.\
-   `[ -s file ]` : تحقق إذا الملف موجود وغير فارغ.

------------------------------------------------------------------------

## 8) مثال عملي (مدخل → مخرجات)

**مدخل (live_hosts.txt):**

    10.0.0.5
    10.0.0.8
    10.0.0.9

**مخرجات (topports.gnmap):**

    Host: 10.0.0.5 ()  Ports: 22/open/tcp//ssh///,80/open/tcp//http///
    Host: 10.0.0.8 ()  Ports: 8080/open/tcp//http-proxy///

**قائمة الأهداف بعد awk + sort:**

    10.0.0.5
    10.0.0.8

------------------------------------------------------------------------

## 9) checklist سريعة

-   [ ] أنشأت مجلد `scans/`.\
-   [ ] شغّلت فحص top-ports.\
-   [ ] استخرجت قائمة الأهداف (`awk` أو `grep`).\
-   [ ] تأكدت أن الملف غير فارغ.\
-   [ ] شغّلت فحص الويب.\
-   [ ] فتحت النتائج (`web-deep.nmap`).

------------------------------------------------------------------------

## ملاحظات أمنية

-   نفّذ الفحص فقط على أنظمة عندك إذن صريح.\
-   لا تشارك المخرجات بدون موافقة العميل.

---

# دليل ملفات الفحص (Recon) — ماذا تحتوي وماذا تستفيد كمختبر اختراق
**اللغة:** العربية — مناسب للاستخدام ضمن سلسلة الريكون والفريق المبتدئ.  
**ملاحظة:** شغّل الفحوصات فقط على أنظمة لديك عليها إذن صريح.

## مقدّمة سريعة
بعد تشغيل سلسلة الفحص ستنتج عدة ملفات داخل مجلد `scans/`. هذا README يوضّح لكل ملف: **وش يحتوي بالضبط**، **الهدف منه كمختبر اختراق**، وأوامر سريعة لاستخراج البيانات المهمة.

---

## 1) `scans/targets_with_open.txt`
**وش فيه؟**  
قائمة بسيطة: سطر لكل IP أو Host اللي عنده موانئ (ports) مفتوحة كما اكتشفها فحص الـtop-ports.

**الهدف كمختبر اختراق (Why):**  
هذا الملف هو نقطة البداية العملية — يعطينا "قائمة أهداف حيّة" نركّز عليها بدل ما نفحص كل الشبكة. أي أدوات لاحقة (ffuf, wayback, nikto) تستخدم هذا الملف كمدخل.

**أوامر سريعة:**  
- عرض: `cat scans/targets_with_open.txt`  
- عدد الأهداف: `wc -l scans/targets_with_open.txt`  
- تشغيل فحص سريع على كل هدف:  
  ```bash
  xargs -a scans/targets_with_open.txt -I{} nmap -Pn -sS -p- -T3 {} -oA scans/fast-{}
  ```

---

## 2) `scans/topports.gnmap`
**وش فيه؟**  
نسخة ملخّصة سطرية من نتائج nmap مع حقل `Ports:` يبيّن البورتات المفتوحة لكل Host.

**الهدف كمختبر اختراق:**  
قراءة سريعة للعثور على أنواع الخدمات المفتوحة (SSH, HTTP, DB, RDP، إلخ). ممتاز لاستخراج أهداف ذات خدمات غير ويب قد تكون لها أولويات خاصة (مثل قواعد بيانات مهيأة بشكل ضعيف).

**أوامر سريعة:**  
- سطور فيها منافذ مفتوحة: `grep "/open/" scans/topports.gnmap`  
- استخراج IP مع ports:  
  ```bash
  awk -F'Ports: ' '{print $1 " | " $2}' scans/topports.gnmap
  ```

---

## 3) `scans/topports.nmap`
**وش فيه؟**  
مخرجات nmap النصية الكاملة للـtop-ports، قابلة للقراءة اليدوية. تتضمن أحيانًا banners وإشارات لإصدارات الخدمات.

**الهدف كمختبر اختراق:**  
استعراض شامل قبل اتخاذ قرار: قد تجد نسخة خادم (مثال: Apache 2.2.15) تشي بوجود ثغرات معروفة؛ أو بانر مصغّر يعطي دلائل عن التطبيقات المستهدفة.

**أوامر سريعة:**  
- فتح ومطالعة: `less scans/topports.nmap`  
- البحث عن كلمات مهمة: `grep -Ei "open|apache|nginx|ssh|mysql" scans/topports.nmap`

---

## 4) `scans/topports.xml`
**وش فيه؟**  
نفس مخرجات nmap بصيغة XML مهيكلة.

**الهدف كمختبر اختراق:**  
ملف مفيد لأتمتة التحليل أو لإدخاله في أدوات إدارة النتائج (Dradis, Faraday، أو سكربتات تحول النتائج إلى CSV/HTML). يسهل استخراج الحقول آليًا (IP، بورتات، حالة).

**أوامر سريعة:**  
- تنسيق للعرض: `xmllint --format scans/topports.xml | less`  
- استخراج العناوين باستخدام xmlstarlet (إن مثبت):  
  ```bash
  xmlstarlet sel -t -m "//host" -v "address/@addr" -n scans/topports.xml
  ```

---

## 5) `scans/web-deep.gnmap`
**وش فيه؟**  
ملف ملخّص لفحص الـweb-deep (output لنفس النمط `.gnmap`) — يظهر ناتج سكربتات nmap المختصّة بالويب بشكل موجز.

**الهدف كمختبر اختراق:**  
نقطة سريعة للبحث عن دلائل web-specific مثل `http-title`, `http-headers`, `ssl-cert` دون فتح الملف الكامل. مناسب لمسح سريع لتحديد أهداف صفحات الويب التي تحتاج فحصًا يدويًا.

**أوامر سريعة:**  
- `grep -i "http-title" scans/web-deep.gnmap`  
- `grep -i "ssl-cert" scans/web-deep.gnmap`

---

## 6) `scans/web-deep.nmap`
**وش فيه؟**  
النص الكامل لفحص الويب المتعمّق: نتائج `http-enum`, `http-headers`, `http-title`, `http-vhosts`, `ssl-cert` وكل مخرجات الـNSE scripts التي شغّلتها.

**الهدف كمختبر اختراق:**  
هذا الملف هو الذهب للـRecon الويبّي. من خلاله تقدر:
- تلاقي صفحات حساسة: `/admin`, `/login`, `/api`.  
- تقرأ رؤوس الاستجابة (Set-Cookie، CSP، X-Frame-Options) وتقيّم إعدادات الأمان.  
- تخرج SANs من شهادة TLS لتوسيع قائمة السوبزدومينات.  
- تحدد إصدارات الخوادم وتبحث عن ثغرات معروفة.

**أوامر مهمة للبحث:**  
- بحث عن صفحات إدارة أو تسجيل دخول:  
  ```bash
  grep -iE "/admin|/login|/wp-admin|/administrator" scans/web-deep.nmap
  ```  
- عرض رؤوس Set-Cookie:  
  ```bash
  grep -i "Set-Cookie" -n scans/web-deep.nmap || true
  ```  
- استخراج بيانات الشهادة (Subject/CN/SAN):  
  ```bash
  grep -i -n "Subject Alternative Name" -A3 scans/web-deep.nmap
  ```

**ترجمة النتيجة لخطوة عملية:**  
- لو لقيت `/admin` → ضع URL في قائمة الفحص اليدوي: اختبار auth-bypass، brute-force (بحذر)، فحص CSRF/XSS.  
- لو لقيت SANs → أضفها للـwordlist والـwayback/gau لجمع URLs أكثر.

---

## 7) `scans/web-deep.xml`
**وش فيه؟**  
نفس محتوى `web-deep.nmap` لكن بصيغة XML منظمة.

**الهدف كمختبر اختراق:**  
مناسب لأدوات التجميع أو السكربتات التي تريد استخراج الحقول أو توليد تقرير HTML/CSV آليًا. يسهل تحليل نتائج الـNSE scripts برمجياً.

**أوامر سريعة (مثال):**  
- تنسيق: `xmllint --format scans/web-deep.xml | less`  
- استخراج كل الـhttp-titles باستخدام xmlstarlet (تقريبي):  
  ```bash
  xmlstarlet sel -t -m "//script" -v . -n scans/web-deep.xml | grep -i "http-title" -A1
  ```

---

## خارطة طريق عملية كمختبر اختراق (ماذا تفعل عمليًا مع هالملفات)
1. **افتح** `scans/targets_with_open.txt` — هذه قائمتك الأساسية للعمل. صنّف العناوين حسب نوع الخدمة (web vs non-web).  
2. **اقرأ** `scans/topports.gnmap` لتمييز الأجهزة التي تحتاج انتباهًا مختلفًا (DB/SSH/RDP).  
3. **افتح** `scans/web-deep.nmap` ودوّن: أي `/admin`, وجود أي ملفات JS حساسة، رؤوس Set-Cookie غير محمية، وSANs في الشهادات.  
4. **جمع** سوبزدومينات من SANs → مرّرها إلى `gau/wayback` → اجمع URLs وملفات JS.  
5. **شغل** ffuf على الأهداف الويبّيّة لاكتشاف مسارات مخفية.  
6. **صنّف** النتائج إلى High/Medium/Low وأبدأ بعمل PoC سريع للعناصر High.

---

## نصائح عملية للفريق المبتدئ
- راجع `web-deep.nmap` يدويًا دومًا — الآلة تعطيك المؤشرات، لكن القراءة البشرية تبيّن السياق.  
- استعمل `.xml` لو حابب تصنع تقارير HTML أو تدخل النتائج في أدوات إدارة.  
- لا تعتمد على ملف واحد؛ اجمع دلائل من `.nmap`, `.gnmap`, و`.xml` قبل اتخاذ قرارات الفحص اليدوي.  
- سجّل كل خطواتك: URL، لقطة شاشة، أوامر شغلتها، ووقت التشغيل — لتوثيق PoC والتقارير.

---

## قالب مختصر للإرفاق بالتقرير (Snippet)
```
ملخص Recon سريع — target.example
- إجمالي الأهداف الحيّة: $(wc -l scans/targets_with_open.txt)
- ملف نتائج الويب الأساسي: scans/web-deep.nmap
- أولويات فحص يدوي: صفحات /admin، ملفات JS المحتملة، شهادات TLS مع SANs
```

---
**انتهى الدليل.**
