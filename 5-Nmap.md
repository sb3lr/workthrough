# دليل عملي للفحص باستخدام Nmap (مرحلة الـRecon)

هذا المستند يشرح خطوة بخطوة سكربت الفحص، كل جزء منفصل: ماذا يفعل، لماذا
نستخدمه، وما النتائج المتوقعة. مناسب للتدريب العملي مع فريق مبتدئ.

------------------------------------------------------------------------

## 1) إنشاء مجلد النتائج

``` bash
mkdir -p scans
```

-   ينشئ مجلد `scans/` لتخزين كل المخرجات.\
-   الخيار `-p` يعني لو المجلد موجود لا يطلع خطأ.

------------------------------------------------------------------------

## 2) الفحص الأولي (Top Ports)

``` bash
nmap -sS -T3 --top-ports 1000 -Pn -iL live_hosts.txt -oA scans/topports
```

### التفصيل

-   `-sS` :
فحص SYN (نصف مفتوح).\
-   `-T3` :
توقيت متوازن (آمن ضد الـIDS).\
-   `--top-ports 1000` :
يفحص أكثر 1000 بورت شائع.\
-   `-Pn` :
يتجاهل ping (مفيد لو ICMP محجوب).\
-   `-iL live_hosts.txt` : 
يقرأ قائمة الأهداف من ملف.\
-   `-oA scans/topports` : 
يحفظ النتيجة بصيغ `.nmap`, `.xml`, `.gnmap`.

------------------------------------------------------------------------

## 3) استخراج المضيفين اللي عندهم بورتات مفتوحة

``` bash
awk '/^Host:/{h=$2}/open/{print h}' scans/topports.gnmap | sort -u > scans/targets_with_open.txt
```

-   `awk` يلتقط الـIP لكل host مفتوح.\
-   `sort -u` يرتب ويزيل التكرارات.\
-   النتيجة تخزن في `scans/targets_with_open.txt`.

### بديل أبسط (لو awk صعب)

``` bash
grep "open" scans/topports.gnmap | cut -d' ' -f2 | sort -u > scans/targets_with_open.txt
```

------------------------------------------------------------------------

## 4) التأكد من وجود أهداف

``` bash
[ -s scans/targets_with_open.txt ]
```

-   يتحقق إن الملف غير فارغ.\
-   لو فيه أهداف → نكمل، لو لا → نوقف.

------------------------------------------------------------------------

## 5) الفحص المتقدم للويب

``` bash
nmap -p 80,443,8080,8443 -sV --script=http-enum,http-headers,http-title,http-vhosts,ssl-cert -T3 -iL scans/targets_with_open.txt -oA scans/web-deep
```

### ماذا يجمع؟

-   `http-enum` : مسارات شائعة مثل `/admin`.\
-   `http-headers` : رؤوس HTTP.\
-   `http-title` : عناوين الصفحات.\
-   `http-vhosts` : Virtual hosts.\
-   `ssl-cert` : شهادات TLS (CN, SANs, تاريخ الانتهاء).

------------------------------------------------------------------------

## 6) في حال ما فيه نتائج

``` bash
|| echo "No open hosts found in topports."
```

-   يظهر رسالة واضحة بدل ما يظل ساكت.

------------------------------------------------------------------------

## 7) شرح الرموز الأساسية

-   `&&` : نفِّذ التالي إذا نجح السابق.\
-   `||` : نفِّذ التالي إذا فشل السابق.\
-   `|` : مرِّر النتيجة كدخل للأمر الثاني.\
-   `>` : اكتب فوق الملف.\
-   `[ -s file ]` : تحقق إذا الملف موجود وغير فارغ.

------------------------------------------------------------------------

## 8) مثال عملي (مدخل → مخرجات)

**مدخل (live_hosts.txt):**

    10.0.0.5
    10.0.0.8
    10.0.0.9

**مخرجات (topports.gnmap):**

    Host: 10.0.0.5 ()  Ports: 22/open/tcp//ssh///,80/open/tcp//http///
    Host: 10.0.0.8 ()  Ports: 8080/open/tcp//http-proxy///

**قائمة الأهداف بعد awk + sort:**

    10.0.0.5
    10.0.0.8

------------------------------------------------------------------------

## 9) checklist سريعة

-   [ ] أنشأت مجلد `scans/`.\
-   [ ] شغّلت فحص top-ports.\
-   [ ] استخرجت قائمة الأهداف (`awk` أو `grep`).\
-   [ ] تأكدت أن الملف غير فارغ.\
-   [ ] شغّلت فحص الويب.\
-   [ ] فتحت النتائج (`web-deep.nmap`).

------------------------------------------------------------------------

## ملاحظات أمنية

-   نفّذ الفحص فقط على أنظمة عندك إذن صريح.\
-   لا تشارك المخرجات بدون موافقة العميل.
